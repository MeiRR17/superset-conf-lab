# =============================================================================
# Nginx Reverse Proxy Configuration
# =============================================================================
# This configuration sets up Nginx as the single entry point for the entire
# Telephony Load Monitoring System. It routes requests to the appropriate
# backend service based on URL path:
#
#   /           -> Apache Superset (port 8088)
#   /api/       -> Proxy Gateway (port 8000)
#   /mock/      -> Mock Server (port 8001)
#
# Features:
# - Load balancing (ready for horizontal scaling)
# - WebSocket support for real-time dashboards
# - Request buffering for large payloads
# - Proper header forwarding for accurate client info
# - Health check endpoints
# =============================================================================

# =============================================================================
# Events Module Configuration
# =============================================================================
# Optimized for handling many concurrent connections typical in web applications
# =============================================================================
events {
    # Worker connections per process - increase for high-traffic environments
    worker_connections 1024;
    
    # Use epoll on Linux for efficient connection handling
    use epoll;
    
    # Accept multiple connections per worker cycle
    multi_accept on;
}

# =============================================================================
# HTTP Module Configuration
# =============================================================================
http {
    # =============================================================================
    # Basic Settings
    # =============================================================================
    
    # MIME type mappings
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # Hide nginx version for security
    server_tokens off;
    
    # =============================================================================
    # Logging Configuration
    # =============================================================================
    # Structured logging for debugging and monitoring
    # =============================================================================
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';
    
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;
    
    # =============================================================================
    # Gzip Compression
    # =============================================================================
    # Compress responses to reduce bandwidth and improve load times
    # =============================================================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json 
               application/javascript application/rss+xml 
               application/atom+xml image/svg+xml;
    
    # =============================================================================
    # Upstream Backend Definitions
    # =============================================================================
    # Define backend server groups for load balancing (ready for scaling)
    # =============================================================================
    
    # Apache Superset upstream
    upstream superset_backend {
        server superset:8088;
        # Add more servers for load balancing:
        # server superset-2:8088;
        # server superset-3:8088;
    }
    
    # Proxy Gateway upstream
    upstream proxy_gateway_backend {
        server proxy-gateway:8000;
    }
    
    # Mock Server upstream
    upstream mock_server_backend {
        server mock-server:8001;
    }
    
    # =============================================================================
    # Main Server Block
    # =============================================================================
    # Listens on port 80 and routes to appropriate backend
    # =============================================================================
    server {
        listen 80;
        listen [::]:80;
        server_name localhost;
        
        # Maximum upload size (for large dashboard exports)
        client_max_body_size 50M;
        
        # =============================================================================
        # Health Check Endpoint
        # =============================================================================
        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        # =============================================================================
        # Proxy Gateway Routes (/api/*)
        # =============================================================================
        # Routes all /api/ requests to the proxy-gateway service
        # =============================================================================
        location /api/ {
            # Remove the /api prefix when forwarding
            rewrite ^/api/(.*) /$1 break;
            
            proxy_pass http://proxy_gateway_backend;
            proxy_http_version 1.1;
            
            # Header forwarding for accurate client info
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Prefix /api;
            
            # WebSocket support (for future real-time features)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Timeouts for long-running operations
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # Buffer settings for response optimization
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }
        
        # =============================================================================
        # Mock Server Routes (/mock/*)
        # =============================================================================
        # Routes all /mock/ requests to the mock-server service
        # Useful for testing and development
        # =============================================================================
        location /mock/ {
            # Remove the /mock prefix when forwarding
            rewrite ^/mock/(.*) /$1 break;
            
            proxy_pass http://mock_server_backend;
            proxy_http_version 1.1;
            
            # Header forwarding
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Prefix /mock;
            
            # Timeouts
            proxy_connect_timeout 10s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
            
            proxy_buffering on;
        }
        
        # =============================================================================
        # Apache Superset Routes (/)
        # =============================================================================
        # Default route - all requests go to Superset unless matched above
        # Handles static assets, dashboard requests, and Superset UI
        # =============================================================================
        location / {
            proxy_pass http://superset_backend;
            proxy_http_version 1.1;
            
            # Essential headers for Superset to work correctly
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            
            # WebSocket support (Superset uses WebSockets for async queries)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            # Extended timeouts for query operations
            proxy_connect_timeout 60s;
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            
            # Handle large query results
            proxy_max_temp_file_size 1024m;
        }
        
        # =============================================================================
        # Static File Caching
        # =============================================================================
        # Optimize delivery of Superset's static assets
        # =============================================================================
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            proxy_pass http://superset_backend;
            
            # Aggressive caching for static assets
            expires 30d;
            add_header Cache-Control "public, immutable";
            add_header Vary Accept-Encoding;
            
            # Don't log static file requests
            access_log off;
        }
    }
    
    # =============================================================================
    # Map for WebSocket Connection header
    # =============================================================================
    # Required for proper WebSocket upgrade handling
    # =============================================================================
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
}
